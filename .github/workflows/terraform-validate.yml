name: Terraform Validation

on:
    pull_request:
        branches:
            - main
            - develop
        paths:
            - "environments/**"
            - "modules/**"
            - ".github/workflows/terraform-validate.yml"
    push:
        branches:
            - main
        paths:
            - "environments/**"
            - "modules/**"
            - ".github/workflows/terraform-validate.yml"

permissions:
    contents: read
    pull-requests: write
    id-token: write

jobs:
    terraform-fmt:
        name: Terraform Format Check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: "~> 1.0"

            - name: Terraform Format Check
              id: fmt
              run: terraform fmt -check -recursive
              continue-on-error: true

            - name: Comment Format Results
              if: github.event_name == 'pull_request' && steps.fmt.outcome == 'failure'
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: 'âš ï¸ **Terraform Format Check Failed**\n\nPlease run `terraform fmt -recursive` to format your code.'
                      })

            - name: Fail if format check failed
              if: steps.fmt.outcome == 'failure'
              run: exit 1

    terraform-validate-dev:
        name: Validate Dev Environment
        runs-on: ubuntu-latest
        needs: terraform-fmt
        defaults:
            run:
                working-directory: environments/dev
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: "~> 1.0"

            - name: Terraform Init
              id: init
              run: terraform init -backend=false

            - name: Terraform Validate
              id: validate
              run: terraform validate

            - name: Comment Validation Results
              if: always() && github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const output = `#### Terraform Validation (Dev) ğŸ–Œ\`${{ steps.validate.outcome }}\`
                      #### Terraform Initialization âš™ï¸\`${{ steps.init.outcome }}\`

                      <details><summary>Show Details</summary>

                      \`\`\`
                      ${{ steps.validate.outputs.stdout }}
                      \`\`\`

                      </details>

                      *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: output
                      })

    terraform-plan-dev:
        name: Plan Dev Environment
        runs-on: ubuntu-latest
        needs: terraform-validate-dev
        if: github.event_name == 'pull_request'
        permissions:
            id-token: write
            contents: read
            pull-requests: write
        defaults:
            run:
                working-directory: environments/dev
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
                  aws-region: ${{ secrets.AWS_REGION }}
                  role-session-name: GitHubActions-TerraformPlan-Dev

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: "~> 1.0"

            - name: Terraform Init
              run: terraform init

            - name: Create terraform.tfvars from secrets
              run: |
                  cat > terraform.tfvars <<EOF
                  project_name                  = "${{ secrets.TF_VAR_PROJECT_NAME }}"
                  aws_region                    = "${{ secrets.TF_VAR_AWS_REGION }}"
                  owner                         = "${{ secrets.TF_VAR_OWNER }}"
                  cost_center                   = "${{ secrets.TF_VAR_COST_CENTER }}"
                  vpc_cidr                      = "${{ secrets.TF_VAR_VPC_CIDR }}"
                  management_subnet_cidr        = "${{ secrets.TF_VAR_MANAGEMENT_SUBNET_CIDR }}"
                  attackbox_subnet_cidr         = "${{ secrets.TF_VAR_ATTACKBOX_SUBNET_CIDR }}"
                  student_labs_cidr             = "${{ secrets.TF_VAR_STUDENT_LABS_CIDR }}"
                  student_lab_subnet_count      = ${{ secrets.TF_VAR_STUDENT_LAB_SUBNET_COUNT }}
                  enable_nat_gateway            = ${{ secrets.TF_VAR_ENABLE_NAT_GATEWAY }}
                  enable_flow_logs              = ${{ secrets.TF_VAR_ENABLE_FLOW_LOGS }}
                  enable_vpc_endpoints          = ${{ secrets.TF_VAR_ENABLE_VPC_ENDPOINTS }}
                  allowed_ssh_cidr              = "${{ secrets.TF_VAR_ALLOWED_SSH_CIDR }}"
                  vpn_port                      = ${{ secrets.TF_VAR_VPN_PORT }}
                  vpn_subnet_cidr               = "${{ secrets.TF_VAR_VPN_SUBNET_CIDR }}"
                  existing_key_pair_name        = "${{ secrets.TF_VAR_KEY_PAIR_NAME }}"
                  guacamole_instance_type       = "${{ secrets.TF_VAR_GUACAMOLE_INSTANCE_TYPE }}"
                  guacamole_domain_name         = "${{ secrets.TF_VAR_GUACAMOLE_DOMAIN_NAME }}"
                  enable_lets_encrypt           = ${{ secrets.TF_VAR_ENABLE_LETS_ENCRYPT }}
                  vpn_instance_type             = "${{ secrets.TF_VAR_VPN_INSTANCE_TYPE }}"
                  enable_sns_alarms             = ${{ secrets.TF_VAR_ENABLE_SNS_ALARMS }}
                  alarm_email                   = "${{ secrets.TF_VAR_ALARM_EMAIL }}"
                  log_retention_days            = ${{ secrets.TF_VAR_LOG_RETENTION_DAYS }}
                  enable_cost_anomaly_detection = ${{ secrets.TF_VAR_ENABLE_COST_ANOMALY_DETECTION }}
                  cost_anomaly_threshold        = ${{ secrets.TF_VAR_COST_ANOMALY_THRESHOLD }}
                  admin_email                   = "${{ secrets.TF_VAR_ADMIN_EMAIL }}"
                  EOF

            - name: Terraform Plan
              id: plan
              run: |
                  terraform plan -no-color -input=false \
                    -var="owner=${{ secrets.TF_VAR_OWNER }}" \
                    -var="allowed_ssh_cidr=${{ secrets.TF_VAR_ALLOWED_SSH_CIDR }}" \
                    -var="existing_key_pair_name=${{ secrets.TF_VAR_KEY_PAIR_NAME }}" \
                    -var="alarm_email=${{ secrets.TF_VAR_ALARM_EMAIL }}" \
                    -var="admin_email=${{ secrets.TF_VAR_ADMIN_EMAIL }}"
              continue-on-error: true

            - name: Comment Plan Results
              uses: actions/github-script@v7
              with:
                  script: |
                      const output = `#### Terraform Plan (Dev) ğŸ“–\`${{ steps.plan.outcome }}\`

                      <details><summary>Show Plan</summary>

                      \`\`\`terraform
                      ${{ steps.plan.outputs.stdout }}
                      \`\`\`

                      </details>

                      *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: output
                      })

            - name: Terraform Plan Status
              if: steps.plan.outcome == 'failure'
              run: exit 1

    terraform-validate-prod:
        name: Validate Prod Environment
        runs-on: ubuntu-latest
        needs: terraform-fmt
        defaults:
            run:
                working-directory: environments/prod
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: "~> 1.0"

            - name: Terraform Init
              id: init
              run: terraform init -backend=false

            - name: Terraform Validate
              id: validate
              run: terraform validate

            - name: Comment Validation Results
              if: always() && github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const output = `#### Terraform Validation (Prod) ğŸ–Œ\`${{ steps.validate.outcome }}\`
                      #### Terraform Initialization âš™ï¸\`${{ steps.init.outcome }}\`

                      <details><summary>Show Details</summary>

                      \`\`\`
                      ${{ steps.validate.outputs.stdout }}
                      \`\`\`

                      </details>

                      *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: output
                      })
