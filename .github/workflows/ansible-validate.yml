name: Ansible Validation

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "ansible/**"
      - ".github/workflows/ansible-validate.yml"
  push:
    branches:
      - main
    paths:
      - "ansible/**"
      - ".github/workflows/ansible-validate.yml"

permissions:
  contents: read
  pull-requests: write

jobs:
  ansible-lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ansible
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "ansible/requirements.txt"

      - name: Install Ansible and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Ansible Galaxy collections
        run: ansible-galaxy collection install -r requirements.yml

      - name: Run yamllint
        id: yamllint
        run: |
          yamllint -c .yamllint.yml . || true
        continue-on-error: true

      - name: Run ansible-lint
        id: lint
        run: ansible-lint playbooks/ roles/
        continue-on-error: true

      - name: Comment Lint Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const lintOutcome = '${{ steps.lint.outcome }}';
            const yamlOutcome = '${{ steps.yamllint.outcome }}';

            let emoji = '✅';
            if (lintOutcome === 'failure' || yamlOutcome === 'failure') {
              emoji = '❌';
            }

            const output = `#### Ansible Lint ${emoji}

            - **ansible-lint:** \`${{ steps.lint.outcome }}\`
            - **yamllint:** \`${{ steps.yamllint.outcome }}\`

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Fail if linting failed
        if: steps.lint.outcome == 'failure'
        run: exit 1

  ansible-syntax:
    name: Ansible Syntax Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ansible
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Install Ansible Galaxy collections
        run: ansible-galaxy collection install -r requirements.yml

      - name: Check Ansible playbook syntax
        id: syntax
        run: |
          for playbook in playbooks/*.yml; do
            echo "Checking syntax for $playbook"
            ansible-playbook --syntax-check "$playbook" -i inventory/hosts.yml.example
          done

      - name: Comment Syntax Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const outcome = '${{ steps.syntax.outcome }}';
            const emoji = outcome === 'success' ? '✅' : '❌';

            const output = `#### Ansible Syntax Check ${emoji}\`${outcome}\`

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
